#!/usr/bin/env node
'use strict';
const fs = require('fs');
const path = require('path');
const vm = require('vm');

const dataDir = path.join(__dirname, '..', 'data');
if (fs.existsSync(dataDir) === false) {
  console.error('data directory not found:', dataDir);
  process.exit(1);
}

const files = fs.readdirSync(dataDir).filter(f => f.endsWith('.js') && f !== 'botStrings.merged.js');
let merged = {};

files.forEach(file => {
  const filePath = path.join(dataDir, file);
  const src = fs.readFileSync(filePath, 'utf8');

  let obj = null;

  // 1) pattern: export default { ... }
  let m = src.match(/export\s+default\s+({[\s\S]*});?\s*$/m);
  if (m) {
    try { obj = (new vm.Script('(' + m[1] + ')')).runInNewContext({}); }
    catch (_) { obj = null; }
  }

  // 2) pattern: const NAME = { ... }; export default NAME;
  if (obj === null) {
    m = src.match(/(?:const|let|var)\s+([A-Za-z0-9_$]+)\s*=\s*({[\s\S]*?});\s*export\s+default\s+\1/);
    if (m) {
      try { obj = (new vm.Script('(' + m[2] + ')')).runInNewContext({}); }
      catch (_) { obj = null; }
    }
  }

  // 3) pattern: module.exports = { ... }
  if (obj === null) {
    m = src.match(/module\.exports\s*=\s*({[\s\S]*?});/);
    if (m) {
      try { obj = (new vm.Script('(' + m[1] + ')')).runInNewContext({}); }
      catch (_) { obj = null; }
    }
  }

  if (obj === null) {
    console.warn('skip (no object export found):', file);
    return;
  }

  if (obj && typeof obj === 'object') {
    merged = Object.assign(merged, obj);
    console.log('merged:', file, Object.keys(obj).length, 'keys');
  } else {
    console.warn('no object parsed from', file);
  }
});

const outPath = path.join(dataDir, 'botStrings.merged.js');
const outContent = `// AUTO-GENERATED by scripts/build-botstrings.js
const botStrings = ${JSON.stringify(merged, null, 2)};
export default botStrings;
`;
fs.writeFileSync(outPath, outContent, 'utf8');
console.log('WROTE', outPath);
